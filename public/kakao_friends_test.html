<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¹´ì¹´ì˜¤ ì¹œêµ¬ ëª©ë¡ í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    button { margin: .5rem; padding: .5rem 1rem; font-size: 1rem; }
    pre    { background: #f0f0f0; padding: 1rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ ì¹´ì¹´ì˜¤ ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</h1>
  <button id="getTokenBtn">1ï¸âƒ£ ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰</button>
  <button id="getFriendsBtn" disabled>2ï¸âƒ£ ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ</button>
  <pre id="output"></pre>
  <!-- í¼ ì „ì†¡ ê²°ê³¼ë¥¼ ë°›ê¸° ìœ„í•œ ìˆ¨ê²¨ì§„ iframe -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
    // 1) REST API Key
    const client_id    = "b753d319ccd4300a4c957d7d4c6c9b96";
    // 2) Redirect URI (ì¹´ì¹´ì˜¤ ì½˜ì†”ì— ë“±ë¡ëœ URL)
    const redirect_uri = "https://kakao-test-ebon.vercel.app/kakao_friends_test.html";
    // 3) Apps Script Web App (doPost) Exec URL
    const SCRIPT_URL   = "https://script.google.com/macros/s/AKfycbzUhoZNpMcu8Lo_M1IgR9eMFbbwPlQNc4RYZ7x1vbMvaVgoRTvbaZWGiYMbknPkhQoX/exec";

    // URL íŒŒë¼ë¯¸í„°ì—ì„œ code, state êº¼ë‚´ê¸°
    const params = new URLSearchParams(window.location.search);
    const code   = params.get("code");
    const state  = params.get("state") || prompt("state íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\në³¸ì¸ì´ ëˆ„êµ¬ì‹ ê°€ìš”?");

    let access_token = "";

    document.getElementById("getTokenBtn").onclick = () => {
      if (!code) {
        // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸/ë™ì˜ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href =
          `https://kauth.kakao.com/oauth/authorize` +
          `?client_id=${client_id}` +
          `&redirect_uri=${encodeURIComponent(redirect_uri)}` +
          `&response_type=code` +
          `&scope=talk_message,friends` +
          `&state=${encodeURIComponent(state)}`;
        return;
      }

      // í† í° êµí™˜ ìš”ì²­
      fetch("https://kauth.kakao.com/oauth/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          grant_type:   "authorization_code",
          client_id,
          redirect_uri,
          code
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) throw new Error(data.error_description);
        access_token = data.access_token;
        document.getElementById("output").textContent =
          "âœ… ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì™„ë£Œ\n" + JSON.stringify(data, null, 2);

        // CORS ìš°íšŒ: hidden iframeì„ ì´ìš©í•œ í¼ POST
        const form = document.createElement("form");
        form.method = "POST";
        form.action = SCRIPT_URL;
        form.target = "hidden_iframe";

        [
          ["state",         state],
          ["access_token",  data.access_token],
          ["refresh_token", data.refresh_token]
        ].forEach(([key, val]) => {
          const input = document.createElement("input");
          input.type  = "hidden";
          input.name  = key;
          input.value = val;
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();

        document.getElementById("getFriendsBtn").disabled = false;
      })
      .catch(err => {
        document.getElementById("output").textContent =
          "âŒ í† í° ìš”ì²­ ì‹¤íŒ¨\n" + err;
      });
    };

    document.getElementById("getFriendsBtn").onclick = () => {
      if (!access_token) {
        alert("ë¨¼ì € ì•¡ì„¸ìŠ¤ í† í°ì„ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }
      fetch("https://kapi.kakao.com/v1/api/talk/friends", {
        method: "GET",
        headers: { Authorization: `Bearer ${access_token}` }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("output").textContent =
          "ğŸ‘¥ ì¹œêµ¬ ëª©ë¡:\n" + JSON.stringify(data, null, 2);
      })
      .catch(err => {
        document.getElementById("output").textContent =
          "âŒ ì¹œêµ¬ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨\n" + err;
      });
    };
  </script>
</body>
</html>
